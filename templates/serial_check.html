{% extends "base_tmp.html" %}
{% block content %}
{#
<head>
    <style>
        /* –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞ */
    .table-hover tbody tr:hover {
        background-color: #fff9db !important; /* –ù—ñ–∂–Ω–æ-–±–ª–∞–∫–∏—Ç–Ω–∏–π */
        transition: background-color 0.2s ease; /* –ü–ª–∞–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ */
    }
    </style>
</head>#}
<!--&#45;&#45; GROUP LIST -&#45;&#45;-->
<div class="container-fluid mt-2"> <h3>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä—ñ–π–Ω–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤</h3>
    <div class="row">
        <div class="col-md-4">
            <form method="POST" action="/scheck" class="card p-3 shadow-sm">
                <div class="mb-3">
                    <label for="serials" class="form-label fw-bold">–í—Å—Ç–∞–≤—Ç–µ —Å–ø–∏—Å–æ–∫:</label>
                    <textarea class="form-control"
                      id="serials"
                      name="serials"
                      rows="15"
                      style="font-family: monospace; font-size: 0.85rem;"
                      placeholder="–û–¥–∏–Ω –Ω–æ–º–µ—Ä –Ω–∞ —Ä—è–¥–æ–∫">{% if raw_data %}{{ raw_data }}{% endif %}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</button>
            </form>
        </div>

        <div class="col-md-8">
            <div class="card p-3 shadow-sm" style="height: 440px;">

                {% if is_multi_sklad %}
                <div class="alert alert-danger d-flex align-items-center mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> <div>
                        <strong>–£–≤–∞–≥–∞! –ó–Ω–∞–π–¥–µ–Ω–æ —Ä—ñ–∑–Ω—ñ —Å–∫–ª–∞–¥–∏:</strong>
                        {{ unique_sklads|join(', ') }}.
                        –û–±—Ä–æ–±–∫–∞ –∑–∞ –æ–¥–Ω–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ—é!
                    </div>
                </div>
                {% endif %}

                <label for="group1" class="form-label fw-bold">–ó–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å:</label>
                <div class="table-responsive">
                    <table id="group1" class="table table-sm table-hover table-bordered table-compact">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>TOVAR ID</th>
                                <th>–ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª.</th>
                                <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
                                <th>–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª</th>
                                <th class="text-center">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                                <th class="text-center">–¶—ñ–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data_g %}
                            <tr>
                                <td class="text-muted">{{ loop.index }}</td>
                                <td><code>{{ row.TOVAR_ID }}</code></td>
                                <td><kbd>{{ row.KOD }}</kbd></td>
                                <td>{{ row.NAME }}</td>
                                <td>{{ row.SKLAD_NAME }}</td>
                                <td class="text-center fw-bold">{{ row.COUNT_ }}</td>
                                <td class="text-center fw-bold">{{ row.PRICE | currency_format_ua }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                    <button type="button" class="btn {{ 'btn-danger' if is_multi_sklad else 'btn-success' }} w-100 mt-2" data-bs-toggle="modal" data-bs-target="#confirmModal">
                        –ü–µ—Ä–µ–¥–∞—Ç–∏ –≤ –ê–∫—Ç –í–∏–∫–æ–Ω–∞–Ω–∏—Ö –†–æ–±—ñ—Ç
                    </button>
                    <div class="mt-3 d-flex align-items-center gap-4 flex-wrap">
                        <h6 class="text-primary fw-bold mb-0">–í—Å—å–æ–≥–æ: {{ total }}</h6>
                        <h6 class="fw-bold mb-0 {{ 'text-danger'  if total_err|int > 0 }}">–ü–æ–º–∏–ª–æ–∫: {{ total_err }}</h6>
                        <h6 class="fw-bold mb-0 {{ 'text-warning' if total_sap|int > 0 }}">–°–ø–∏—Å–∞–Ω–æ: {{ total_sap }}</h6>
                        <h6 class="fw-bold mb-0 {{ 'text-success' if total_acc|int > 0 }}">–ù–∞ –æ–±–ª—ñ–∫—É: {{ total_acc }}</h6>
                    </div>

            </div>
        </div>
    </div>
</div>


<!-- -&#45;&#45;  MAIN LIST -->

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}?v={{ app_version }}">

<!--<table class="table table-main" id="resultsTable">-->
<table class="table table-main" id="tList">
    <thead>
        <tr>
            <th>–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä
<!--                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyColumn(0)">üìã</button>-->
            </th>
            <th>TOVAR_ID</th>
            <th>TOVAR_KOD</th>
            <th>PRICE</th>
            <th>NAME</th>
            <th>STATUS</th>
            <th>SKLAD_NAME</th>
<!--            <th>-->
<!--                TOVAR_ID | TOVAR_KOD | TOVAR_NAME | STATUS | SKLAD_NAME | PRICE-->
<!--                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyColumn(1)">üìã</button>-->
<!--            </th>-->
        </tr>
    </thead>
    <tbody>
        {% for row in column_data %}
        <tr style="--bs-table-bg: {{ row.STATUS_COLOR }}; color: #000;">
            <td>{{ row.TOVAR_SER_NUM }}</td>
            <td>{{ row.NUM }}</td>
            <td>{{ row.KOD }}</td>
            <td>{{ row.PRICE | currency_format_ua }}</td>
            <td>{{ row.NAME }}</td>
            <td>{{ row.STATUS }}</td>
            <td>{{ row.SKLAD_NAME }}</td>
        </tr> {#
<!--            <tr class="{{ 'table-secondary' if row.c_ex > 1-->
<!--                     else 'table-danger'  if '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ'         in row.status-->
<!--                     else 'table-success' if '–ù–∞ –æ–±–ª—ñ–∫—É'           in row.status-->
<!--                     else 'table-warning' if '–°–ø–∏—Å–∞–Ω–æ (–∞–∫—Ç –ø—É—Å–∫—É)' in row.status-->
<!--                     }}">-->
<!--                <td>{{ row.sn }}</td>-->
<!--                <td>{{ row.status }}</td>-->
<!--            </tr>-->#}
        {% endfor %}
    </tbody>
</table>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ–±—Ä–æ–±–∏—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏?</p>
                <div class="mb-3">
                    <label for="doc_id" class="form-label fw-bold">–í–≤–µ–¥—ñ—Ç—å ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
                    <input type="number" class="form-control" id="doc_id" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 12345">
                </div>
                <div id="modalStatus" class="mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <button type="button" id="btnRunAction" class="btn btn-danger" onclick="runAll()">
                    –í–∏–∫–æ–Ω–∞—Ç–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É
                </button>
            </div>
        </div>
    </div>
</div>


<script src="{{ url_for('static', filename='js/tables.js') }}"></script>

<script>
function runAll() {
    const docId = document.getElementById('doc_id').value.trim();
    if (!docId) {
        alert("–í–≤–µ–¥—ñ—Ç—å ID –¥–æ–∫—É–º–µ–Ω—Ç–∞!");
        return;
    }

    const btn = document.getElementById('btnRunAction');
    const statusDiv = document.getElementById('modalStatus');

    // –ë–ª–æ–∫—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∫–Ω–æ–ø–∫—É –¥—ñ—ó, —â–æ–± –Ω–µ –±—É–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö –∫–ª—ñ–∫—ñ–≤
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –û–±—Ä–æ–±–∫–∞...';
    statusDiv.innerHTML = ''; // –û—á–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Å—Ç–∞—Ç—É—Å

    fetch('/add-to-actvr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ doc_id: docId })
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        return data;
    })
    .then(data => {
        // –£—Å–ø—ñ—Ö
        statusDiv.innerHTML = `<div class="alert alert-success mt-2">${data.message}</div>`;
        btn.innerText = "–í–∏–∫–æ–Ω–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ";
        // –ó–∞–ª–∏—à–∞—î–º–æ –∫–Ω–æ–ø–∫—É disabled, —â–æ–± –Ω–µ –∫–ª–∞—Ü–∞–ª–∏ –≤–¥—Ä—É–≥–µ –ø—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É
    })
    .catch(err => {
        // –ü–æ–º–∏–ª–∫–∞
        statusDiv.innerHTML = `<div class="alert alert-danger mt-2" style="white-space: pre-wrap;">${err.message}</div>`;
        btn.disabled = false; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
        btn.innerText = "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É";
    });
}

// –û—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ, —â–æ–± –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∞–∑—É –≤—Å–µ –±—É–ª–æ "–∑ –Ω—É–ª—è"
document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function () {
    const btn = document.getElementById('btnRunAction');
    btn.disabled = false;
    btn.innerText = "–í–∏–∫–æ–Ω–∞—Ç–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É";
    document.getElementById('modalStatus').innerHTML = '';
    document.getElementById('doc_id').value = '';
});
</script>

{#<!--<script>-->
<!--function copyColumn(colIndex) {-->
<!--    const table = document.getElementById('resultsTable');-->
<!--    let rows = table.querySelectorAll('tbody tr');-->

<!--    // –ó–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç —ñ–∑ –≤–∏–±—Ä–∞–Ω–æ–≥–æ —Å—Ç–æ–≤–ø—Ü—è-->
<!--    let textToCopy = Array.from(rows)-->
<!--        .map(row => {-->
<!--            const cell = row.cells[colIndex];-->
<!--            return cell ? cell.innerText.trim() : '';-->
<!--        })-->
<!--        .filter(text => text !== '') // —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏-->
<!--        .join('\n');-->

<!--    if (!textToCopy) {-->
<!--        alert('–ù—ñ—á–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞—Ç–∏!');-->
<!--        return;-->
<!--    }-->

<!--    // –†–µ–∑–µ—Ä–≤–Ω–∏–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞-->
<!--    const textArea = document.createElement("textarea");-->
<!--    textArea.value = textToCopy;-->

<!--    // –†–æ–±–∏–º–æ –π–æ–≥–æ –Ω–µ–≤–∏–¥–∏–º–∏–º-->
<!--    textArea.style.position = "fixed";-->
<!--    textArea.style.left = "-9999px";-->
<!--    textArea.style.top = "0";-->
<!--    document.body.appendChild(textArea);-->

<!--    textArea.focus();-->
<!--    textArea.select();-->

<!--    try {-->
<!--        const successful = document.execCommand('copy');-->
<!--        if (successful) {-->
<!--            alert('–°—Ç–æ–≤–ø—á–∏–∫ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä!');-->
<!--        } else {-->
<!--            console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏');-->
<!--        }-->
<!--    } catch (err) {-->
<!--        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—ñ:', err);-->
<!--    }-->

<!--    document.body.removeChild(textArea);-->
<!--}-->
<!--</script>-->#}

{% endblock %}