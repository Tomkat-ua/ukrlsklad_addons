{% extends "base_tmp.html" %}
{% block content %}

<!--&#45;&#45; GROUP LIST -&#45;&#45;-->
<div class="container-fluid mt-2"> <h3>Перевірка серійних номерів</h3>
    <div class="row">
        <div class="col-md-4">
            <form method="POST" action="/scheck" class="card p-3 shadow-sm">
                <div class="mb-3">
                    <label for="serials" class="form-label fw-bold">Вставте список:</label>
                    <textarea class="form-control"
                      id="serials"
                      name="serials"
                      rows="15"
                      style="font-family: monospace; font-size: 0.85rem;"
                      placeholder="Один номер на рядок">{% if raw_data %}{{ raw_data }}{% endif %}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Запустити перевірку</button>
            </form>
        </div>

        <div class="col-md-8">
            <div class="card p-3 shadow-sm" style="height: 440px;">

                {% if is_multi_sklad %}
                <div class="alert alert-danger d-flex align-items-center mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> <div>
                        <strong>Увага! Знайдено різні склади:</strong>
                        {{ unique_sklads|join(', ') }}.
                        Обробка за одним документом може бути некоректною!
                    </div>
                </div>
                {% endif %}

                <label for="group1" class="form-label fw-bold">Знайдено відповідність:</label>
                <div class="table-responsive">
                    <table id="group1" class="table table-sm table-hover table-bordered table-compact">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>TOVAR ID</th>
                                <th>Код номенкл.</th>
                                <th>Найменування</th>
                                <th>Підрозділ</th>
                                <th class="text-center">Кількість</th>
                                <th class="text-center">Ціна</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data_g %}
                            <tr>
                                <td class="text-muted">{{ loop.index }}</td>
                                <td><code>{{ row.TOVAR_ID }}</code></td>
                                <td><kbd>{{ row.KOD }}</kbd></td>
                                <td>{{ row.NAME }}</td>
                                <td>{{ row.SKLAD_NAME }}</td>
                                <td class="text-center fw-bold">{{ row.COUNT_ }}</td>
                                <td class="text-center fw-bold">{{ row.PRICE | currency_format_ua }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                    <button type="button" class="btn {{ 'btn-danger' if is_multi_sklad else 'btn-success' }} w-100 mt-2" data-bs-toggle="modal" data-bs-target="#confirmModal">
                        Передати в Акт Виконаних Робіт
                    </button>
                    <div class="mt-3 d-flex align-items-center gap-4 flex-wrap">
                        <h6 class="text-primary fw-bold mb-0">Всього: {{ total }}</h6>
                        <h6 class="fw-bold mb-0 {{ 'text-danger'  if total_err|int > 0 }}">Помилок: {{ total_err }}</h6>
                        <h6 class="fw-bold mb-0 {{ 'text-warning' if total_sap|int > 0 }}">Списано: {{ total_sap }}</h6>
                        <h6 class="fw-bold mb-0 {{ 'text-success' if total_acc|int > 0 }}">На обліку: {{ total_acc }}</h6>
                    </div>

            </div>
        </div>
    </div>
</div>


<!-- -&#45;&#45;  MAIN LIST -->

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}?v={{ app_version }}">


<table class="table table-main" id="tList">
    <thead>
        <tr>
            <th>Серійний номер
            </th>
            <th>TOVAR_ID</th>
            <th>TOVAR_KOD</th>
            <th>PRICE</th>
            <th>NAME</th>
            <th>STATUS</th>
            <th>SKLAD_NAME</th>
        </tr>
    </thead>
    <tbody>
        {% for row in column_data %}
        <tr style="--bs-table-bg: {{ row.STATUS_COLOR }}; color: #000;">
            <td>{{ row.TOVAR_SER_NUM }}</td>
            <td>{{ row.NUM }}</td>
            <td>{{ row.KOD }}</td>
            <td>{{ row.PRICE | currency_format_ua }}</td>
            <td>{{ row.NAME }}</td>
            <td>{{ row.STATUS }}</td>
            <td>{{ row.SKLAD_NAME }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Підтвердження обробки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ви впевнені, що хочете обробити всі записи?</p>
                <div class="mb-3">
                    <label for="doc_id" class="form-label fw-bold">Введіть ID документа:</label>
                    <input type="number" class="form-control" id="doc_id" required placeholder="Наприклад: 12345">
                </div>
                <div id="modalStatus" class="mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрити</button>
                <button type="button" id="btnRunAction" class="btn btn-danger" onclick="runAll()">
                    Виконати процедуру
                </button>
            </div>
        </div>
    </div>
</div>


<script src="{{ url_for('static', filename='js/tables.js') }}"></script>

<script>
function runAll() {
    const docId = document.getElementById('doc_id').value.trim();
    if (!docId) {
        alert("Введіть ID документа!");
        return;
    }

    const btn = document.getElementById('btnRunAction');
    const statusDiv = document.getElementById('modalStatus');

    // Блокуємо тільки кнопку дії, щоб не було повторних кліків
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Обробка...';
    statusDiv.innerHTML = ''; // Очищуємо попередній статус

    fetch('/add-to-actvr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ doc_id: docId })
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Помилка сервера');
        return data;
    })
    .then(data => {
        // Успіх
        statusDiv.innerHTML = `<div class="alert alert-success mt-2">${data.message}</div>`;
        btn.innerText = "Виконано успішно";
        // Залишаємо кнопку disabled, щоб не клацали вдруге після успіху
    })
    .catch(err => {
        // Помилка
        statusDiv.innerHTML = `<div class="alert alert-danger mt-2" style="white-space: pre-wrap;">${err.message}</div>`;
        btn.disabled = false; // Повертаємо можливість спробувати знову
        btn.innerText = "Спробувати знову";
    });
}

// Очищення при закритті, щоб наступного разу все було "з нуля"
document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function () {
    const btn = document.getElementById('btnRunAction');
    btn.disabled = false;
    btn.innerText = "Виконати процедуру";
    document.getElementById('modalStatus').innerHTML = '';
    document.getElementById('doc_id').value = '';
});
</script>

{% endblock %}