{% extends "base_tmp.html" %}
{% block content %}
<head>
    <style>
        /* –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞ */
    .table-hover tbody tr:hover {
        background-color: #fff9db !important; /* –ù—ñ–∂–Ω–æ-–±–ª–∞–∫–∏—Ç–Ω–∏–π */
        transition: background-color 0.2s ease; /* –ü–ª–∞–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ */
    }
    </style>
</head>
<!--&#45;&#45;-->
<div class="container-fluid mt-2"> <h3>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä—ñ–π–Ω–∏—Ö –Ω–æ–º–µ—Ä—ñ–≤</h3>
    <div class="row">
        <div class="col-md-4">
            <form method="POST" action="/scheck" class="card p-3 shadow-sm">
                <div class="mb-3">
                    <label for="serials" class="form-label fw-bold">–í—Å—Ç–∞–≤—Ç–µ —Å–ø–∏—Å–æ–∫:</label>
                    <textarea class="form-control"
                      id="serials"
                      name="serials"
                      rows="15"
                      style="font-family: monospace; font-size: 0.85rem;"
                      placeholder="–û–¥–∏–Ω –Ω–æ–º–µ—Ä –Ω–∞ —Ä—è–¥–æ–∫">{% if raw_data %}{{ raw_data }}{% endif %}</textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</button>
            </form>
        </div>

        <div class="col-md-8">
            <div class="card p-3 shadow-sm" style="height: 440px;">
                <label for="group1" class="form-label fw-bold">–ó–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å:</label>
                <div class="table-responsive">
                    <table id="group1" class="table table-sm table-hover table-bordered table-compact">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>TOVAR ID</th>
                                <th>TOVAR KOD</th>
                                <th>NAME</th>
                                <th class="text-center">COUNT</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data_g %}
                            <tr>
                                <td class="text-muted">{{ loop.index }}</td>
                                <td><code>{{ row.TOVAR_ID }}</code></td>
                                <td><kbd>{{ row.KOD }}</kbd></td>
                                <td>{{ row.NAME }}</td>
                                <td class="text-center fw-bold">{{ row.COUNT_ }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-danger w-100 mt-2" data-bs-toggle="modal" data-bs-target="#confirmModal">
                        –ü–µ—Ä–µ–¥–∞—Ç–∏ –≤ –ê–∫—Ç –í–∏–∫–æ–Ω–∞–Ω–∏—Ö –†–æ–±—ñ—Ç
                    </button>
                    <div class="mt-3">
                        <h6 class="text-primary fw-bold">–í—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤: {{ total }}</h6>
                        <h6 class="fw-bold {{ 'text-danger' if total_err|int > 0 }}">–ü–æ–º–∏–ª–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤: {{ total_err }}</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--    &#45;&#45;-->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}?v={{ app_version }}">

<table class="table table-sm table-compact" id="resultsTable">
    <thead>
        <tr>
            <th>
                –°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyColumn(0)">üìã</button>
            </th>
            <th>
                –°—Ç–∞—Ç—É—Å –ë–î
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyColumn(1)">üìã</button>
            </th>
        </tr>
    </thead>
    <tbody>
        {% for row in results %}
            <tr class="{{ 'table-danger'  if '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ'         in row.status
                     else 'table-success' if '–ù–∞ –æ–±–ª—ñ–∫—É'           in row.status
                     else 'table-warning' if '–°–ø–∏—Å–∞–Ω–æ (–∞–∫—Ç –ø—É—Å–∫—É)' in row.status }}">
                <td>{{ row.sn }}</td>
                <td>{{ row.status }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ–±—Ä–æ–±–∏—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏?</p>
                <div class="mb-3">
                    <label for="doc_id" class="form-label fw-bold">–í–≤–µ–¥—ñ—Ç—å ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
                    <input type="number" class="form-control" id="doc_id" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 12345">
                </div>
                <div id="modalStatus" class="mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" id="btnRunAction" class="btn btn-danger" onclick="runAll()">–í–∏–∫–æ–Ω–∞—Ç–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É</button>
            </div>
        </div>
    </div>
</div>


<script src="{{ url_for('static', filename='js/tables.js') }}"></script>
    <script>
        $(document).ready(function() {
            initDefaultDataTable('#tList', {
                "pageLength": 25 // –ú–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            });
        });
    </script>
<script>
function runAll() {
    const docId = document.getElementById('doc_id').value;
    const btn = document.getElementById('btnRunAction');
    const statusDiv = document.getElementById('modalStatus');

    if (!docId) {
        alert("–í–≤–µ–¥—ñ—Ç—å ID –¥–æ–∫—É–º–µ–Ω—Ç–∞!");
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –û–±—Ä–æ–±–∫–∞...';

    fetch('/add-to-actvr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ doc_id: docId })
    })
    .then(async response => {
        const isJson = response.headers.get('content-type')?.includes('application/json');
        const data = isJson ? await response.json() : null;

        if (!response.ok) {
            // –í–∏—Ç—è–≥—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: —è–∫—â–æ —Ü–µ –Ω–∞—à JSON - –±–µ—Ä–µ–º–æ message, —ñ–Ω–∞–∫—à–µ - —á–∏—Å—Ç–∏–π —Ç–µ–∫—Å—Ç
            const errorText = data ? data.message : await response.text();
            throw new Error(errorText);
        }
        return data;
    })
    .then(data => {
        statusDiv.innerHTML = `<div class="alert alert-success mt-2">${data.message}</div>`;

        // –ó–º—ñ–Ω—é—î–º–æ –≤–∏–≥–ª—è–¥ –∫–Ω–æ–ø–∫–∏
        btn.className = "btn btn-success w-100";
        btn.innerText = "–ì–æ—Ç–æ–≤–æ! –ó–∞–∫—Ä–∏—Ç–∏ –≤—ñ–∫–Ω–æ";

        // –î–æ–¥–∞—î–º–æ –∞—Ç—Ä–∏–±—É—Ç, —è–∫–∏–π –¥–æ–∑–≤–æ–ª–∏—Ç—å –∫–Ω–æ–ø—Ü—ñ –∑–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª—ñ–∫—É
        btn.setAttribute("data-bs-dismiss", "modal");

        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å: –∫–Ω–æ–ø–∫–∞ —Ç–µ–ø–µ—Ä –∞–∫—Ç–∏–≤–Ω–∞ –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è
        btn.disabled = false;
    })
    .catch(err => {
        console.error(err);
        // –í–∏–≤–æ–¥–∏–º–æ –ø–æ–º–∏–ª–∫—É –∫—Ä–∞—Å–∏–≤–æ
        statusDiv.innerHTML = `
            <div class="alert alert-danger mt-2" style="font-size: 0.85rem; white-space: pre-wrap; font-family: monospace;">
                <strong>–ü–æ–º–∏–ª–∫–∞ –ë–î:</strong>\n${err.message}
            </div>`;

        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–Ω–æ–ø—Ü—ñ —Ä–æ–±–æ—á–∏–π —Å—Ç–∞–Ω
        btn.disabled = false;
        btn.className = "btn btn-danger";
        btn.innerText = "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É";
    })
    .finally(() => {
        // –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —â–æ—Å—å –∑—Ä–æ–±–∏—Ç–∏ –∑–∞–≤–∂–¥–∏ –≤ –∫—ñ–Ω—Ü—ñ
    });
}

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª–∫–∏
document.getElementById('confirmModal').addEventListener('shown.bs.modal', function () {
    document.getElementById('doc_id').focus();
});
</script>
<script>
function copyColumn(colIndex) {
    const table = document.getElementById('resultsTable');
    let rows = table.querySelectorAll('tbody tr');

    // –ó–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç —ñ–∑ –≤–∏–±—Ä–∞–Ω–æ–≥–æ —Å—Ç–æ–≤–ø—Ü—è
    let textToCopy = Array.from(rows)
        .map(row => {
            const cell = row.cells[colIndex];
            return cell ? cell.innerText.trim() : '';
        })
        .filter(text => text !== '') // —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏
        .join('\n');

    if (!textToCopy) {
        alert('–ù—ñ—á–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞—Ç–∏!');
        return;
    }

    // –†–µ–∑–µ—Ä–≤–Ω–∏–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
    const textArea = document.createElement("textarea");
    textArea.value = textToCopy;

    // –†–æ–±–∏–º–æ –π–æ–≥–æ –Ω–µ–≤–∏–¥–∏–º–∏–º
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    document.body.appendChild(textArea);

    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            alert('–°—Ç–æ–≤–ø—á–∏–∫ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ —É –±—É—Ñ–µ—Ä!');
        } else {
            console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏');
        }
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—ñ:', err);
    }

    document.body.removeChild(textArea);
}
</script>

{% endblock %}