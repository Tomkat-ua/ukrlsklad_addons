{% extends "base_tmp.html" %}
{% block content %}

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<body class="p-4 bg-light">

<div class="container">
    <h2 class="mb-4">{{ repname }}</h2>
    <button class="btn btn-sm btn-primary" onclick="copyTable()">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é</button>
    <button class="btn btn-sm btn-primary" onclick="downloadTableAsCSV('{{ repname }}')">–ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ CSV</button>
    <button class="btn btn-sm btn-primary" onclick="downloadTableAsXLSX('{{ repname }}')">–ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ XLSX</button>
    <div class="table-responsive">
        <table id="tList" class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    {% for col in columns %}
                        <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                    <tr>
                        {% for cell in row %}
                            <td>{{ cell }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</body>
<script>
function copyTable() {
    let table = document.getElementById("tList");
    let range = document.createRange();
    range.selectNode(table);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
    alert("–¢–∞–±–ª–∏—Ü—é —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä üìã");
}

function downloadTableAsCSV(fileName) {
    let table = document.getElementById("tList");
    let rows = table.querySelectorAll("tr");
    let csv = [];

    rows.forEach(row => {
        let cols = row.querySelectorAll("th, td");
        let rowData = [];
        cols.forEach(col => rowData.push('"' + col.innerText.replace(/"/g, '""') + '"'));
        csv.push(rowData.join(","));
    });

        const now = new Date();
        const datePart = now.toISOString().split('T')[0]; // 2025-10-09
        const time = now.toTimeString().split(' ')[0];    // 16:47:33
        const [hours, minutes] = time.split(':');
        const timePart = `${hours}-${minutes}`;           // 16-47
      const fileNameFull = `${fileName}_${datePart}_${timePart}`;

    // –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–π–ª
    let csvString = csv.join("\n");
    let blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileNameFull +".csv";  // –Ω–∞–∑–≤–∞ —Ñ–∞–π–ª—É
    link.click();
    alert(`‚úÖ –§–∞–π–ª "${fileNameFull}.csv" –∑–±–µ—Ä–µ–∂–µ–Ω–æ`);
}

function downloadTableAsXLSX(fileName) {
    if (!fileName) fileName = "table"; // –¥–µ—Ñ–æ–ª—Ç

        const now = new Date();
        const datePart = now.toISOString().split('T')[0]; // 2025-10-09
        const time = now.toTimeString().split(' ')[0];    // 16:47:33
        const [hours, minutes] = time.split(':');
        const timePart = `${hours}-${minutes}`;           // 16-47
      const fileNameFull = `${fileName}_${datePart}_${timePart}`;

    let table = document.getElementById("tList");
    let wb = XLSX.utils.book_new();
    let ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "–¢–∞–±–ª–∏—Ü—è");
    XLSX.writeFile(wb, fileNameFull + ".xlsx");
    alert(`‚úÖ –§–∞–π–ª "${fileNameFull}.xlsx" –∑–±–µ—Ä–µ–∂–µ–Ω–æ`);
}

</script>

{% endblock %}